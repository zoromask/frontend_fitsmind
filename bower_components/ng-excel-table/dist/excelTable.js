"use strict";angular.module("excel-table",["ui.bootstrap"]).factory("excelTableModel",function(){var e=null,t=null,a=null,l=null;return{setDataModel:function(t){e=t},getDataModel:function(){return e},setModel:function(e){e=e},getModel:function(){return t},setPredicate:function(e){e=e},getPredicate:function(){return a},setReverse:function(e){e=e},getReverse:function(){return l}}}).filter("startFrom",function(){return function(e,t){return e?(t=+t,e.slice(t)):[]}}).directive("tbCell",["$window","excelTableModel","$timeout",function(e,t,a){return{restrict:"A",link:function(e,t,l){e.$watch(function(){return t.height()},function(e,l){a(function(){if(-1!=t.attr("class").indexOf("tb-row tb-cell row-")&&-1==t.attr("class").indexOf("tb-row tb-cell row-{{$index+1}}-{{tableId}}")){for(var e=document.getElementsByClassName(t.attr("class")),a=0,l=0;l<e.length;l++)a<e[l].offsetHeight&&(a=e[l].offsetHeight);for(var l=0;l<e.length;l++)e[l]!=t[0]&&(e[l].style.height=a+"px")}if(-1!=t.attr("class").indexOf("table-header-container")){for(var e=document.getElementsByClassName(t.attr("class")),a=0,l=0;l<e.length;l++)a<e[l].offsetHeight&&(a=e[l].offsetHeight);for(var l=0;l<e.length;l++)e[l]!=t[0]&&(e[l].style.height=a+"px")}})}),t.on("mouseover",function(){if(-1!=l["class"].indexOf("row-"))for(var e=document.getElementsByClassName(l["class"]),t=e.length,a=0;t>a;a++)e[a].className+=" row-hover"}),t.on("mouseout",function(){if(-1!=l["class"].indexOf("row-"))for(var e=document.getElementsByClassName(l["class"]),t=e.length,a=0;t>a;a++)e[a].className=e[a].className.replace(" row-hover","")}),e.editRow=function(t){e.$emit("editRow",t)},t.on("click",function(){if(-1!=t[0].className.indexOf("sortable")){if(void 0!=e.recordEditing)return!1;var a=!0,i=document.getElementsByClassName("sortable"),n=t[0].querySelector(".fa"),o=l.column;if(void 0==n)return!1;for(var r=0;r<i.length;r++)i[r].className=i[r].className.replace(" active","");t[0].className+=" active",-1==n.className.indexOf("desc")?(n.className=n.className.replace("asc","desc"),a=!1):(n.className=n.className.replace("desc","asc"),a=!0),e.order(o,a)}})}}}]).directive("compileHtml",["$compile",function(e){return function(t,a,l){t.$watch(function(e){return e.$eval(l.compileHtml)},function(l){a.html(l),e(a.contents())(t)})}}]).directive("excelTable",["$compile","$filter","excelTableModel","$http","$rootScope",function(e,t,a,l,i){return{scope:{model:"=model",data:"=data",tableOption:"=tblOption"},restrict:"E",templateUrl:"template/table.html",link:function(e,n,o){e.tableId="xtable-"+o.id,e.cellFilter={},e.dataParams={start:0,length:0,sort:{predicate:"",order:"ASC"},search:{}},e.totalWidth="100%",e.tblDefaultOptions={type:"local",forceFit:!0,allowPaging:!1,allowFilter:!1,dblClickToEdit:!0,rud:{customScopeParams:void 0,read:void 0,update:void 0},pagingOption:void 0},Object.keys(e.tblDefaultOptions).map(function(t,a){void 0!=e.tableOption&&(e.tblDefaultOptions[t]=e.tableOption[t])}),e.tableOption=e.tblDefaultOptions,n.bind("scroll",function(){this.querySelector(".ctrl-panel-wrapper").style.left=this.offsetWidth/2-100+this.scrollLeft+"px"}),e.recursiveGroupHeader=function(t){for(var a=t.items,l=0,i=0;i<a.length;i++)l+=void 0!=a[i].items?e.recursiveGroupHeader(a[i]):a[i].width;return t.width=l,l},e.recursiveModelGroupHeader=function(t,a,l){for(var i=t.items,n=0;n<i.length;n++)void 0!=i[n].items?e.recursiveModelGroupHeader(i[n],a,l+1):e.tableOption.forceFit?i[n].width=i[n].width/t.width*100+"%":i[n].width=i[n].width-(n==i.length-1?l+1:0)+"px";e.tableOption.forceFit?t.width=t.width/a*100+"%":t.width=t.width-1+"px"};for(var r=0,d=0;d<e.model.length;d++)void 0!=e.model[d].items?r+=e.recursiveGroupHeader(e.model[d]):(e.tableOption.forceFit||(e.model[d].width+="px"),r+=parseFloat(e.model[d].width));for(var d=0;d<e.model.length;d++)void 0!=e.model[d].items?e.recursiveModelGroupHeader(e.model[d],r,0):e.tableOption.forceFit&&(e.model[d].width=e.model[d].width/r*100+"%");e.tableOption.forceFit||(e.totalWidth=r+1+"px",n.width(e.totalWidth));var s=t("orderBy");e.order=function(t,a){"remote"==e.tableOption.rud.read.type?(e.predicate=t,e.dataParams.sort={predicate:t,order:a?"ASC":"DESC"},e.getRecords()):(e.predicate=t,e.data=s(e.data,t,!a),e.$apply())},e.getRecords=function(){if(void 0!=e.tableOption.rud.read){var t={url:e.tableOption.rud.read.url,method:e.tableOption.rud.read.method,withCredentials:void 0==e.tableOption.rud.credentials?!1:e.tableOption.rud.credentials,header:e.tableOption.rud.header};"remote"==e.tableOption.rud.read.type&&(t.data=e.tableOption.rud.read.data,void 0!=t.data[e.tableOption.rud.customScopeParams]?Object.keys(e.dataParams).map(function(a,l){void 0!=t.data[e.tableOption.rud.customScopeParams][a]&&(t.data[e.tableOption.rud.customScopeParams][a]=e.dataParams[a])}):t.data[e.tableOption.rud.customScopeParams]=e.dataParams),l(t).then(function(t){e.data=t.data.data,e.tableOption.allowPaging&&(e.paging.totalItems=t.data.totalItems),"function"==typeof e.tableOption.rud.read.fn.success&&e.tableOption.rud.read.fn.success(t)},function(t){"function"==typeof e.tableOption.rud.read.fn.success&&e.tableOption.rud.read.fn.failure(t)})}},i.$on("rowEditing",function(t,a){e.recordEditing=a}),a.setModel(e.model),a.setDataModel(e.data),e.primaryKey=o.primary,e.tableOption.allowPaging?(e.paging={currentPage:1,totalItems:void 0,pagingSize:void 0,itemsPerPage:5,boundaryLinks:!1,boundaryLinkNumbers:!1,rotate:!0,directionLinks:!0,firstText:"First",previousText:"Previous",nextText:"Next",lastText:"Last",forceEllipses:!1},Object.keys(e.paging).map(function(t,a){void 0!=e.tableOption.pagingOption[t]&&(e.paging[t]=e.tableOption.pagingOption[t])}),e.dataParams.start=0,e.dataParams.length=e.paging.itemsPerPage,e.getRecords(),e.pageChanged=function(){"remote"==e.tableOption.rud.read.type&&(e.dataParams.start=(e.paging.currentPage-1)*e.paging.itemsPerPage,e.getRecords())},e.updateTableData=function(){return void 0!=e.recordEditing?!1:void("remote"==e.tableOption.rud.read.type&&(e.paging.currentPage=1,e.dataParams.start=0,e.dataParams.length=e.paging.itemsPerPage,e.getRecords()))}):e.getRecords(),e.$watch("cellFilter",function(a,l){void 0!=e.tableOption.rud.read&&"remote"==e.tableOption.rud.read.type?(e.paging.currentPage=1,e.dataParams.search=a,e.getRecords()):(e.filtered=t("filter")(e.data,a),void 0!=e.filtered&&void 0!=e.paging&&(e.paging.totalItems=e.filtered.length,e.currentPage=1))},!0)}}}]).run(["$templateCache",function(e){e.put("template/table.html",'<div class="excel-table" style="width:{{totalWidth}}"><div class="tb-col" ng-repeat="col in model" style="width:{{col.width}}"><div tb-cell="" class="table-header-container"><div tb-cell="" class="{{tableId}} tb-cell header" data-column="{{col.dataIndex}}" ng-class="{\'sortable\' : col.sortable, \'group-header\':col.items.length > 0, \'col-{{col.dataIndex}}\':col.items == undefined}">{{col.title}} <span class="pull-right" ng-if="col.sortable"><i class="fa fa-sort-amount-asc"></i></span></div><div class="group-header-item"><div class="tb-col" ng-repeat="col in col.items" style="width:{{col.width}}" ng-class="{\'first-group-header\' : $first, \'last-group-header\' : $last}" ng-include="\'template/group_header.html\'"></div></div></div><div ng-if="col.items == undefined"><div ng-if="tableOption.allowFilter" tb-cell="" class="tb-cell cell-filter col-{{col.dataIndex}}"><input ng-disabled="col.allowFilter == false || col.type == \'html\'" class="form-control" type="text" ng-model="cellFilter[col.dataIndex]"></div><div tb-cell="" data-index="{{$index}}" data-record="{{cell[primaryKey]}}" class="tb-row tb-cell row-{{$index+1}}-{{tableId}}" ng-repeat="cell in {true: (data | filter:cellFilter | startFrom:(paging.currentPage-1)*paging.itemsPerPage | limitTo:paging.itemsPerPage), false: (data | filter:cellFilter)}[tableOption.rud.read.type == \'local\'] track by $index" ng-switch="col.type"><span ng-switch-when="date" ng-bind="cell[col.dataIndex] | date:col.dateFormat"></span> <span ng-switch-when="html" compile-html="col.html"></span> <span ng-switch-default="" ng-bind="cell[col.dataIndex]"></span></div></div><div ng-if="col.items != undefined"><div class="tb-col" ng-repeat="col in col.items" style="width:{{col.width}}" ng-include="\'template/group_columns.html\'"></div></div></div></div><div class="table-control form-group" ng-if="tableOption.allowPaging"><pagination class="pagination-sm right" ng-model="paging.currentPage" total-items="paging.totalItems" max-size="paging.pagingSize" items-per-page="paging.itemsPerPage" boundary-links="paging.boundaryLinks" boundary-link-numbers="paging.boundaryLinkNumbers" rotate="paging.rotate" direction-links="paging.directionLinks" first-text="{{paging.firstText}}" previous-text="{{paging.previousText}}" next-text="{{paging.nextText}}" last-text="{{paging.lastText}}" force-ellipses="paging.forceEllipses" ng-change="pageChanged()" num-pages="numPages"></pagination><div class="pager-limitTo"><label>Per page:</label> <input type="number" class="form-control" ng-model="paging.itemsPerPage" min="1" max="100" step="1" ng-change="updateTableData()"> <label>{{paging.itemsPerPage > 1 ? \'records\' : \'record\'}}</label></div></div>'),e.put("template/group_columns.html",'<div style="width: 100%;"><div ng-if="col.items == undefined"><div ng-if="tableOption.allowFilter" tb-cell="" class="tb-cell cell-filter col-{{col.dataIndex}}"><input ng-disabled="col.allowFilter == false || col.type == \'html\'" class="form-control" type="text" ng-model="cellFilter[col.dataIndex]"></div><div tb-cell="" data-index="{{$index}}" data-record="{{cell[primaryKey]}}" class="tb-row tb-cell row-{{$index+1}}-{{tableId}}" ng-repeat="cell in {true: (data | filter:cellFilter | startFrom:(paging.currentPage-1)*paging.itemsPerPage | limitTo:paging.itemsPerPage), false: (data | filter:cellFilter)}[tableOption.rud.read.type == \'local\'] track by $index" ng-switch="col.type"><span ng-switch-when="date" ng-bind="cell[col.dataIndex] | date:col.dateFormat"></span> <span ng-switch-when="html" compile-html="col.html"></span> <span ng-switch-default="" ng-bind="cell[col.dataIndex]"></span></div></div><div ng-if="col.items != undefined"><div class="tb-col" ng-repeat="col in col.items" style="width:{{col.width}}" ng-include="\'template/group_columns.html\'"></div></div></div>'),e.put("template/group_header.html",'<div style="width: 100%;"><div tb-cell="" class="{{tableId}} tb-cell header" data-column="{{col.dataIndex}}" ng-class="{\'sortable\' : col.sortable, \'group-header\':col.items.length > 0, \'col-{{col.dataIndex}}\':col.items == undefined}">{{col.title}} <span class="pull-right" ng-if="col.sortable"><i class="fa fa-sort-amount-asc"></i></span></div><div class="group-header-item"><div class="tb-col" ng-repeat="col in col.items" style="width:{{col.width}}" ng-class="{\'first-group-header\' : $first, \'last-group-header\' : $last}" ng-include="\'template/group_header.html\'"></div></div></div>')}]);