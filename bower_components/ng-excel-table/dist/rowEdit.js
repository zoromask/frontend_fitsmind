"use strict";angular.module("xtable.rowEdit",["isteven-multi-select"]).value("defaults",{editable:!0}).filter("getCurrentEditRecord",function(){return function(t,e,a){for(var i in t)if(t[i][e]==a)return t[i]}}).filter("findType",function(){return function(t,e){var a=[];for(var i in t)t[i].type===e&&a.push(t[i]);return a}}).filter("mappingDataToList",function(){return function(t,e,a){for(var i in t)delete t[i].ticked;if(!(e instanceof String))return"Invalid Format of List";var d=e.split(",");for(var l in d)for(var i in t)t[i][a]===d[l]&&(t[i].ticked=!0);return t}}).directive("rowEditing",["$window","excelTableModel","$templateRequest","$compile","defaults","$filter","$http","$rootScope",function(t,e,a,i,d,l,n,r){return{restrict:"A",link:function(t,e,o){t.editable=d.editable,t.picker={},t.datefield={},t.listIn={},t.listOut={},t.listCfg={};var c=l("findType")(t[o.model],"list");for(var s in c)t.listCfg[c[s].dataIndex]={btnDisplay:c[s].btnDisplay,itemDisplay:c[s].itemDisplay,valueDisplay:c[s].valueDisplay,multiSelect:c[s].multiSelect?"multiple":"single"},t.listIn[c[s].dataIndex]=c[s].store,t.listOut[c[s].dataIndex]={};var p=l("findType")(t[o.model],"date");for(var s in p)t.picker[p[s].dataIndex]={dateOptions:{dateDisabled:function(t,e){return p[s].disableWeekend?"day"===e&&(0===t.getDay()||6===t.getDay()):!1},maxDate:void 0==p[s].maxDate?"":p[s].maxDate,minDate:void 0==p[s].minDate?"":p[s].minDate,startingDay:void 0==p[s].startingDay?0:p[s].startingDay},opened:!1};a("template/rowediting.html").then(function(a){t.data=t[o.data],t.model=t[o.model];var d=i(a)(t);e.append(d)}),t.editRow=function(a){e[0].querySelector(".ctrl-panel-wrapper").style.left=e[0].offsetWidth/2-100+e[0].scrollLeft+"px";for(var i=[];a.target&&(i.unshift(a.target),!a.target.matches(".tb-row.tb-cell"));){if(a.target.matches(".xtable"))return!1;a.target=a.target.parentNode}if(a.target&&a.target.matches(".tb-row.tb-cell")){t.data=t[o.data],t.model=t[o.model],t.recordEditing=l("getCurrentEditRecord")(t[o.data],o.primary,a.target.dataset.record),r.$emit("rowEditing",t.recordEditing);for(var d=a.target;d&&(d=d.parentNode,-1==d.className.indexOf("excel-table")););for(var n=a.target.offsetTop,c=d.offsetLeft,s=a.target.offsetHeight,p=a.target.offsetWidth,f=d.parentNode.getElementsByClassName("cell-edit"),u=0;u<f.length;u++)switch(f[u].style.width=p+"px",f[u].parentNode.dataset.type){case"date":var m=new Date(t.recordEditing[f[u].parentNode.dataset.field]);m instanceof Date&&"invalid date"!=m.toString().toLowerCase()?t.datefield[f[u].parentNode.dataset.field]=l("date")(m,f[u].parentNode.dataset.dateformat):t.datefield[f[u].parentNode.dataset.field]=l("date")(new Date,f[u].parentNode.dataset.dateformat);break;case"list":var g=t.listIn[f[u].parentNode.dataset.field],b=new String(t.recordEditing[f[u].parentNode.dataset.field]),v=t.listCfg[f[u].parentNode.dataset.field].valueDisplay;t.listIn[f[u].parentNode.dataset.field]=l("mappingDataToList")(g,b,v);break;default:f[u].value=t.recordEditing[f[u].parentNode.dataset.field]}if(t.tableEl=d.parentNode,!t[o.tblOption].forceFit){for(var y=0,w=0;w<t.model.length;w++)y+=parseFloat(t.model[w].width);t.tableEl.querySelector(".row-edit-form").style.width=y+2+"px"}t.tableEl.querySelector(".row-edit-form").style.display="block",t.tableEl.querySelector(".row-edit-form").style.top=n+"px",t.tableEl.querySelector(".row-edit-form").style.left=c+"px",t.tableEl.querySelector(".row-edit-form").style.height=s+"px",t[o.tblOption].dblClickToEdit&&t.$apply()}},t[o.tblOption].dblClickToEdit?e.on("dblclick",function(e){t.editRow(e)}):t.$on("editRow",function(e,a){t.editRow(a)}),t.$watch(o.data,function(e){if(void 0!=t.recordEditing){for(var a=0;a<e.length;a++)if(e[a]===t.recordEditing){var i=a+1;break}if(void 0!=i){var d=t.tableEl.querySelector(".tb-cell.row-"+i).offsetTop;t.tableEl.querySelector(".row-edit-form").style.top=d+"px"}}}),t.save=function(){for(var e=t.tableEl,a=e.getElementsByClassName("cell-edit"),i=0;i<a.length;i++){var d=null;switch(a[i].parentNode.dataset.type){case"number":d=Number(a[i].value.replace(/[., ]/gi,""));break;case"string":d=a[i].value.toString();break;case"date":var l=t.datefield[a[i].parentNode.dataset.field];d=l instanceof Date?l:"Invalid Date";break;case"list":var l=t.listOut[a[i].parentNode.dataset.field],n=t.listCfg[a[i].parentNode.dataset.field].valueDisplay;d=[];for(var r in l)d.push(l[r][n]);d=d.join()}t.recordEditing[a[i].parentNode.dataset.field]=d}t.tableEl.querySelector(".row-edit-form").style.display="none",t.saveUpdatedRecord()},t.cancel=function(){t.tableEl.querySelector(".row-edit-form").style.display="none",t.recordEditing=void 0,r.$emit("rowEditing",void 0)},t.saveUpdatedRecord=function(){if("remote"==t[o.tblOption].rud.update.type){var e={url:t[o.tblOption].rud.update.url,method:t[o.tblOption].rud.read.method,withCredentials:void 0==t[o.tblOption].rud.credentials?!1:t.tableOption.rud.credentials,header:t[o.tblOption].rud.header};e.data=t[o.tblOption].rud.update.data,e.data[t[o.tblOption].rud.customScopeParams]=t.recordEditing,n(e).then(function(e){t.recordEditing=void 0,r.$emit("rowEditing",void 0),"function"==typeof t[o.tblOption].rud.update.fn.success&&t[o.tblOption].rud.update.fn.success(e)},function(e){"function"==typeof t[o.tblOption].rud.update.fn.failure&&t[o.tblOption].rud.update.fn.failure(e)})}else{var a=t.recordEditing;"function"==typeof t[o.tblOption].rud.update.fn.success&&t[o.tblOption].rud.update.fn.success(a),"function"==typeof t[o.tblOption].rud.update.fn.failure&&t[o.tblOption].rud.update.fn.failure(a),t.recordEditing=void 0,r.$emit("rowEditing",void 0)}},t.openDatePicker=function(e,a){e.preventDefault(),e.stopPropagation(),t.picker[a].opened=!0}}}}]).run(["$templateCache",function(t){t.put("template/rowediting.html",'<div class="excel-table row-edit-form"><div class="tb-col" ng-repeat="col in model" style="width:{{col.width}}"><div ng-if="col.editable == true || col.editable == undefined" class="tb-cell" data-field="{{col.dataIndex}}" data-type="{{col.type}}" data-dateformat="{{col.dateFormat}}"><input class="cell-edit" type="number" ng-if="col.type == \'number\'"> <input class="cell-edit" type="text" ng-if="col.type == \'string\'"><isteven-multi-select class="cell-edit" ng-if="col.type == \'list\'" input-model="listIn[col.dataIndex]" output-model="listOut[col.dataIndex]" button-label="{{listCfg[col.dataIndex].btnDisplay}}" item-label="{{listCfg[col.dataIndex].itemDisplay}}" tick-property="ticked" selection-mode="{{listCfg[col.dataIndex].multiSelect}}"></isteven-multi-select><div class="cell-edit datepicker" ng-if="col.type == \'date\'"><input type="text" class="form-control" datepicker-popup="{{col.dateFormat}}" ng-model="datefield[col.dataIndex]" is-open="picker[col.dataIndex].opened" min-date="picker[col.dataIndex].dateOptions.minDate" max-date="picker[col.dataIndex].dateOptions.maxDate" datepicker-options="picker[col.dataIndex].dateOptions" date-disabled="picker[col.dataIndex].dateOptions.dateDisabled(date, mode)" close-text="Close"> <span class="input-group-btn"><button type="button" class="btn btn-default" ng-click="openDatePicker($event, col.dataIndex)"><i class="glyphicon glyphicon-calendar"></i></button></span></div></div><div ng-if="col.editable == false" class="tb-cell" data-field="{{col.dataIndex}}" data-type="{{col.type}}"><input class="cell-edit" type="text" disabled=""></div></div><div class="ctrl-panel-container"><div class="ctrl-panel-wrapper"><span class="save" ng-click="save()">Save</span> <span class="cancel" ng-click="cancel()">Cancel</span></div></div></div>')}]);